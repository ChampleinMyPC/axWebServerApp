<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <title>ACAP Export – Fenêtres 15 min</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b1220;
      --card: #0f172a;
      --surface: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --primary: #22d3ee;
      --primary-strong: #06b6d4;
      --primary-fg: #001018;
      --ring: #22d3ee44;
      --border: #1f2937;
      --chip: #172554;
      --chip-fg: #93c5fd;
      --ok: #34d399;
      --err: #f87171;
      --shadow: 0 10px 30px rgba(0, 0, 0, .35), inset 0 1px 0 rgba(255, 255, 255, .02);
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 500px at 10% -10%, #0ea5e980, transparent 50%),
        radial-gradient(1000px 500px at 110% 20%, #22d3ee40, transparent 50%),
        var(--bg);
      padding: 24px;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .shell {
      width: min(1100px, 96vw);
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 16px;
    }

    .topbar {
      background: linear-gradient(180deg, #0b1220, #0c1424 60%, #0b1426);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: .3px;
    }

    .badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      color: var(--chip-fg);
      background: var(--chip);
      border: 1px solid #1e3a8a;
    }

    .actions {
      display: flex;
      align-items: end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    label {
      font-size: 12px;
      color: var(--muted);
    }

    input {
      background: #0b1220;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      box-shadow: inset 0 0 0 1px transparent;
    }

    /* #start, #end{  color:white; } */
    input:focus {
      box-shadow: 0 0 0 3px var(--ring);
      border-color: var(--primary-strong);
    }

    .custom-datetime-picker {
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .custom-datetime-picker input {
      background: #0b1220;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      width: 180px;
      cursor: pointer;
    }

    .custom-datetime-picker input:focus {
      outline: none;
      box-shadow: 0 0 0 3px var(--ring);
      border-color: var(--primary-strong);
    }

    .calendar-btn {
      background: var(--primary);
      border: none;
      border-radius: 6px;
      padding: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-fg);
      transition: background 0.3s ease;
    }

    .calendar-btn:hover {
      background: var(--primary-strong);
    }

    .calendar-popup {
      position: absolute;
      top: 110%;
      left: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 12px;
      z-index: 100;
      display: none;
      width: 280px;
      user-select: none;
    }

    .calendar-popup[aria-hidden="false"] {
      display: block;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      color: var(--text);
      font-weight: 700;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .calendar-day {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-weight: 700;
    }

    .calendar-date {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text);
      background: transparent;
      transition: background 0.2s ease;
    }

    .calendar-date:hover {
      background: var(--primary);
      color: var(--primary-fg);
    }

    .calendar-date.selected {
      background: var(--primary-strong);
      color: var(--primary-fg);
      font-weight: 700;
    }

    .time-inputs {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      justify-content: center;
      color: var(--text);
    }

    .time-inputs input {
      width: 60px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-weight: 700;
      text-align: center;
      outline: none;
    }

    .time-inputs input:focus {
      border-color: var(--primary-strong);
      box-shadow: 0 0 0 3px var(--ring);
    }

    .btn {
      appearance: none;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: .2px;
    }

    .btn.primary {
      background: linear-gradient(180deg, var(--primary), var(--primary-strong));
      color: var(--primary-fg);
      box-shadow: 0 10px 20px #06b6d455;
    }

    .btn.ghost {
      background: #0b1220;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .main {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: linear-gradient(180deg, #0d1629, #0f172a);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    .side {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .side .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .side .title {
      font-size: 13px;
      color: var(--muted);
    }

    .cam {
      font-weight: 800;
      letter-spacing: .2px;
    }

    .content {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .content h2 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .2px;
    }

    .chipline {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 13px;
    }

    .chip {
      background: #00111a;
      color: #67e8f9;
      border: 1px solid #0e7490;
      padding: 3px 10px;
      border-radius: 999px;
      font-weight: 700;
    }

    .summary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 640px) {
      .summary {
        grid-template-columns: 1fr;
      }
    }

    .info {
      background: #0b1220;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }

    .info h4 {
      margin: 0 0 6px;
      font-size: 14px;
      color: #cbd5e1;
    }

    .info small {
      color: var(--muted);
      display: block;
    }

    .truncate {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .files {
      border: 1px dashed #223047;
      background: #0b1220;
      border-radius: 12px;
      padding: 8px;
      max-height: 52vh;
      overflow: auto;
    }

    .file {
      padding: 9px 10px;
      border-bottom: 1px dashed #1e293b;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      color: #cbd5e1;
      display: flex;
      gap: 10px;
    }

    .file:last-child {
      border-bottom: none;
    }

    .status {
      color: var(--muted);
      font-size: 13px;
      text-align: right;
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 800;
      margin-left: 6px;
    }

    .pill.ok {
      background: #022c22;
      color: var(--ok);
      border: 1px solid #064e3b;
    }

    .pill.err {
      background: #2f0b0b;
      color: var(--err);
      border: 1px solid #7f1d1d;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(3, 7, 18, .7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      width: min(420px, calc(100vw - 32px));
      background: linear-gradient(180deg, #0b1220, #0f172a);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .modal h3 {
      margin: 0 0 6px;
      text-align: center;
    }

    .modal .hint {
      color: var(--muted);
      text-align: center;
      font-size: 12px;
    }

    .modal .row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .modal .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .error {
      color: var(--err);
    }

    .sr-only {
      position: absolute;
      left: -9999px;
    }
  </style>
</head>

<body>
  <div class="shell">
    <header class="topbar">
      <div class="brand">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3l7.794 4.5v9L12 21 4.206 16.5v-9L12 3z" stroke="#67e8f9" stroke-width="1.2" />
          <path d="M12 7l4 2.3v4.4L12 16l-4-2.3V9.3L12 7z" fill="#22d3ee" />
        </svg>
        ACAP Export
        <span class="badge">Fenêtres 15 min</span>
      </div>
      <div class="actions">
        <div class="field">
          <label for="start">Début (UTC)</label>
          <div class="custom-datetime-picker" id="start-picker">
            <input id="start" type="text" readonly required />
            <button type="button" class="calendar-btn" aria-label="Select start date">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
            </button>
            <div class="calendar-popup" id="start-calendar" tabindex="-1" aria-hidden="true"></div>
          </div>
        </div>
        <div class="field">
          <label for="end">Fin (UTC)</label>
          <div class="custom-datetime-picker" id="end-picker">
            <input id="end" type="text" readonly required />
            <button type="button" class="calendar-btn" aria-label="Select end date">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
            </button>
            <div class="calendar-popup" id="end-calendar" tabindex="-1" aria-hidden="true"></div>
          </div>
        </div>
        <button id="btnList" class="btn primary">Lister</button>
        <button id="btnSend" class="btn ghost">Envoyer au serveur</button>
      </div>
    </header>

    <section class="main">
      <aside class="card side">
        <div class="row">
          <div>
            <div class="title">Caméra</div>
            <div class="cam" id="camDisplay">(non configurée)</div>
          </div>
          <button id="btnEditCam" class="btn ghost" title="Changer URL/IP caméra">Changer</button>
        </div>
        <div class="row" style="justify-content:flex-start; gap:8px;">
          <span class="title">Jour courant</span>
          <span id="today" class="badge" style="border-color:#0e7490; background:#00111a; color:#67e8f9"></span>
        </div>
      </aside>

      <div class="card content">
        <h2>Fichiers trouvés</h2>
        <div class="chipline">Plage sélectionnée <span class="chip" id="chipRange">UTC</span></div>

        <div class="summary" id="summary">
          <div class="info">
            <h4>Premier fichier</h4>
            <small id="firstTs">—</small>
            <!-- <span id="firstPath" class="truncate">—</span> -->
            <small id="firstSize">—</small>
            <small id="firstMinDeb">Min début: —</small>
            <small id="firstMinFin">Min fin: —</small>
            <small id="firstHHMMDeb">Début HH:MM: —</small>
            <small id="firstHHMMFin">Fin HH:MM: —</small>
          </div>
          <div class="info">
            <h4>Dernier fichier</h4>
            <small id="lastTs">—</small>
            <!-- <span id="lastPath" class="truncate">—</span> -->
            <small id="lastSize">—</small>
            <small id="lastMinDeb">Min début: —</small>
            <small id="lastMinFin">Min fin: —</small>
            <small id="lastHHMMDeb">Début HH:MM: —</small>
            <small id="lastHHMMFin">Fin HH:MM: —</small>
          </div>
        </div>

        <div class="files" id="files"></div>
        <div class="status" id="status"></div>
      </div>
    </section>
  </div>

  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Configurer l’URL/IP de la caméra</h3>
      <p id="camMsg" class="hint">Exemples : <code>http://192.168.1.51</code> ou <code>http://cam-salle-1.local</code>
      </p>
      <div class="row">
        <label class="sr-only" for="cameraBase">URL/IP caméra</label>
        <input id="cameraBase" type="text" placeholder="http://192.168.x.x" style="flex:1" />
      </div>
      <div class="actions">
        <button id="cancelCam" class="btn ghost">Annuler</button>
        <button id="saveCam" class="btn primary">Utiliser</button>
      </div>
    </div>
  </div>

  <script>
    const PROD_MODE = false;
    const q = (s) => document.querySelector(s);
    const fmtLocalToIsoZ = (local) => (!local ? "" : (local.length === 16 ? local + ":00Z" : local));
    const pad = (n) => String(n).padStart(2, '0');
    const formatUtcDateTime = (d) => d.getUTCFullYear() + "-" + pad(d.getUTCMonth() + 1) + "-" + pad(d.getUTCDate()) + " " + pad(d.getUTCHours()) + ":" + pad(d.getUTCMinutes());

    function normalizeAndValidateCameraBase(input) {
      let val = (input || '').trim();
      if (!val) return { ok: false, msg: 'URL/IP requise.' };
      if (!/^https?:\/\//i.test(val)) val = 'http://' + val;
      try { const u = new URL(val); if (!u.hostname) throw new Error('hostname vide'); return { ok: true, url: u.origin }; }
      catch { return { ok: false, msg: 'URL/IP invalide. Exemple : http://192.168.1.51' }; }
    }
    function buildApiBase(baseUrl) { let u; try { u = new URL(baseUrl); } catch { return null; } if (!u.port) u.port = '2001'; return u.origin.replace(/:\d+$/, '') + ':2001'; }
    function detectDefaultCameraBase() { return (location.hostname && location.protocol.startsWith('http')) ? location.origin : ''; }
    const loadCameraBase = () => localStorage.getItem('cameraBase') || '';
    const saveCameraBase = (url) => localStorage.setItem('cameraBase', url);

    function updateCamDisplay() {
      const raw = loadCameraBase();
      const check = normalizeAndValidateCameraBase(raw);
      const api = check.ok ? buildApiBase(check.url) : '';
      let ip = '';
      if (api) { try { ip = new URL(api).hostname; } catch { ip = api; } }
      q('#camDisplay').textContent = ip || '(non configurée)';
    }

    function openModal(prefill = '') { q('#cameraBase').value = prefill; q('#camMsg').className = 'hint'; q('#modalBackdrop').style.display = 'flex'; setTimeout(() => q('#cameraBase').focus(), 50); }
    function closeModal() { q('#modalBackdrop').style.display = 'none'; }

    (function initDefaults() {
      const now = new Date();
      const pad = (n) => String(n).padStart(2, '0');
      const toUtcLocalStr = (d) => d.getUTCFullYear() + "-" + pad(d.getUTCMonth() + 1) + "-" + pad(d.getUTCDate()) + " " + pad(d.getUTCHours()) + ":" + pad(d.getUTCMinutes());
      const d0 = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));
      const d1 = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 0));
      q('#start').value = toUtcLocalStr(d0);
      q('#end').value = toUtcLocalStr(d1);
      q('#today').innerText = "UTC " + d0.toISOString().slice(0, 10);
      q('#chipRange').textContent = q('#start').value + ' → ' + q('#end').value + 'Z';

      const auto = detectDefaultCameraBase();
      const stored = loadCameraBase();
      const candidate = stored || auto; const check = candidate ? normalizeAndValidateCameraBase(candidate) : { ok: false };
      if (check.ok) saveCameraBase(check.url);
      q('#btnEditCam').disabled = !!PROD_MODE; updateCamDisplay();
    })();

    ['start', 'end'].forEach(id => {
      q('#' + id).addEventListener('change', () => {
        const s = fmtLocalToIsoZ(q('#start').value); const e = fmtLocalToIsoZ(q('#end').value);
        q('#chipRange').textContent = (s || '') + ' → ' + (e || '');

        // Enforce start < end
        const startVal = q('#start').value;
        const endVal = q('#end').value;
        if (startVal && endVal) {
          const startDate = new Date(startVal);
          const endDate = new Date(endVal);
          if (startDate > endDate) {
            const newEnd = new Date(startDate.getTime() + 60 * 60 * 1000); // +1 hour
            q('#end').value = formatUtcDateTime(newEnd);
            q('#chipRange').textContent = q('#start').value + ' → ' + q('#end').value + 'Z';
          } else if (endDate < startDate) {
            const newStart = new Date(endDate.getTime() - 60 * 60 * 1000); // -1 hour
            q('#start').value = formatUtcDateTime(newStart);
            q('#chipRange').textContent = q('#start').value + ' → ' + q('#end').value + 'Z';
          }
        }
      });
    });

    q('#cancelCam').addEventListener('click', () => closeModal());
    q('#saveCam').addEventListener('click', () => {
      const { ok, url, msg } = normalizeAndValidateCameraBase(q('#cameraBase').value);
      if (!ok) { q('#camMsg').textContent = msg; q('#camMsg').className = 'hint error'; return; }
      saveCameraBase(url); closeModal(); updateCamDisplay();
      q('#status').textContent = `Caméra configurée: ${buildApiBase(url)}`;
    });
    q('#btnEditCam').addEventListener('click', () => { if (!q('#btnEditCam').disabled) openModal(loadCameraBase()); });

    let lastListed = [];

    function parseFlexibleTs(ts) {
      if (!ts) return null;
      const m = ts.match(/^(\d{8})T(\d{2})(\d{2})(\d{2})?Z$/);
      if (!m) return null;
      const [_, ymd, HH, MM, SS] = m;
      const y = ymd.slice(0, 4), mo = ymd.slice(4, 6), d = ymd.slice(6, 8);
      const ss = SS || '00';
      const iso = `${y}-${mo}-${d}T${HH}:${MM}:${ss}Z`;
      const dt = new Date(iso);
      return isNaN(dt.getTime()) ? null : dt;
    }

    function extractTimesFromPath(path) {
      if (!path) return {};
      const re = /(\d{8}T\d{4}(?:\d{2})?Z)/g;
      const found = [];
      let m;
      while ((m = re.exec(path)) !== null) { found.push(m[1]); }
      if (!found.length) return {};
      const startStr = found[0] || '';
      const endStr = found[found.length - 1] || '';
      const startDate = parseFlexibleTs(startStr);
      const endDate = parseFlexibleTs(endStr);
      const startMinute = startDate ? startDate.getUTCMinutes() : undefined;
      const endMinute = endDate ? endDate.getUTCMinutes() : undefined;
      return { startStr, endStr, startDate, endDate, startMinute, endMinute };
    }

    function normalizeEntry(e) {
      if (typeof e === 'string') {
        const parts = e.split('|').map(s => s.trim());
        const tsStr = parts[0] || '';
        const path = parts[1] || '';
        const sizeStr = parts[2] || '';
        const size = parseInt(sizeStr, 10) || (parseInt((sizeStr.match(/\d+/) || ['0'])[0], 10) || 0);
        const timeMeta = extractTimesFromPath(path);
        return { ts: tsStr, path, size, tsDate: parseFlexibleTs(tsStr.replace(/_+$/, '')), ...timeMeta };
      }
      const tsStr = e.ts || '';
      const path = e.path || '';
      const size = Number(e.size) || 0;
      const timeMeta = extractTimesFromPath(path);
      return { ts: tsStr, path, size, tsDate: parseFlexibleTs(tsStr.replace(/_+$/, '')), ...timeMeta };
    }

    function pad2(n) { return String(n ?? '').padStart(2, '0'); }
    function hhmmUTC(d) { if (!d) return null; return pad2(d.getUTCHours()) + ':' + pad2(d.getUTCMinutes()); }

    function renderSummary(items) {
      const first = items.reduce((a, b) => {
        if (!a) return b; if (!a.tsDate) return b; if (!b.tsDate) return a; return a.tsDate <= b.tsDate ? a : b;
      }, null);
      const last = items.reduce((a, b) => {
        if (!a) return b; if (!a.tsDate) return b; if (!b.tsDate) return a; return a.tsDate >= b.tsDate ? a : b;
      }, null);
      const fmt = (d) => d && d.tsDate ? d.tsDate.toISOString().replace(':00.000', '').replace('.000', '') : '—';

      q('#firstTs').textContent = first ? (first.ts || fmt(first)) : '—';
      // q('#firstPath').textContent = first ? first.path : '—';
      q('#firstSize').textContent = first ? `${first.size} bytes` : '—';
      q('#firstMinDeb').textContent = 'Min début: ' + (first && typeof first.startMinute === 'number' ? pad2(first.startMinute) : '—');
      q('#firstHHMMDeb').textContent = 'Début HH:MM: ' + (first && first.startDate ? hhmmUTC(first.startDate) : '—');
      q('#firstMinFin').textContent = 'Min fin: ' + (first && typeof first.endMinute === 'number' ? pad2(first.endMinute) : '—');
      q('#firstHHMMFin').textContent = 'Fin HH:MM: ' + (first && first.endDate ? hhmmUTC(first.endDate) : '—');

      q('#lastTs').textContent = last ? (last.ts || fmt(last)) : '—';
      // q('#lastPath').textContent = last ? last.path : '—';
      q('#lastSize').textContent = last ? `${last.size} bytes` : '—';
      q('#lastMinDeb').textContent = 'Min début: ' + (last && typeof last.startMinute === 'number' ? pad2(last.startMinute) : '—');
      q('#lastHHMMDeb').textContent = 'Début HH:MM: ' + (last && last.startDate ? hhmmUTC(last.startDate) : '—');
      q('#lastMinFin').textContent = 'Min fin: ' + (last && typeof last.endMinute === 'number' ? pad2(last.endMinute) : '—');
      q('#lastHHMMFin').textContent = 'Fin HH:MM: ' + (last && last.endDate ? hhmmUTC(last.endDate) : '—');
    }

    function clearSummary() {
      const defaults = {
        firstTs: '—', firstSize: '—', firstMinDeb: 'Min début: —', firstHHMMDeb: 'Début HH:MM: —', firstMinFin: 'Min fin: —', firstHHMMFin: 'Fin HH:MM: —',
        lastTs: '—', lastSize: '—', lastMinDeb: 'Min début: —', lastHHMMDeb: 'Début HH:MM: —', lastMinFin: 'Min fin: —', lastHHMMFin: 'Fin HH:MM: —'
      };
      Object.entries(defaults).forEach(([id, val]) => { q('#' + id).textContent = val; });
    }

    async function requireCameraBaseOrModal() {
      const base = loadCameraBase();
      const check = normalizeAndValidateCameraBase(base);
      const api = check.ok ? buildApiBase(check.url) : null;
      if (!api) { openModal(base); throw new Error('cameraBase non configurée'); }
      return api;
    }

    function setStatus(text, sent = undefined, failed = undefined) {
      const el = q('#status');
      if (sent === undefined && failed === undefined) { el.textContent = text; return; }
      el.innerHTML = `${text} <span class="pill ok">Envoyés: ${sent || 0}</span><span class="pill err">Échecs: ${failed || 0}</span>`;
    }
    function showError(msg) {
      const el = q('#status');
      el.innerHTML = `<span class="pill err">${msg}</span>`;
    }

    async function listFiles() {
      setStatus("Listing en cours…"); q('#files').innerHTML = ""; lastListed = []; clearSummary();

      // ✅ VALIDATION DES DATES
      const startRaw = q('#start').value; // ex: "2025-09-26T10:00"
      const endRaw = q('#end').value;

      if (!startRaw || !endRaw) {
        showError("Veuillez renseigner les deux dates (début et fin).");
        return;
      }

      // On force l'interprétation en UTC pour la comparaison (ajout de 'Z')
      const sMs = Date.parse(startRaw + 'Z');
      const eMs = Date.parse(endRaw + 'Z');

      if (Number.isNaN(sMs) || Number.isNaN(eMs)) {
        showError("Format de date invalide.");
        return;
      }
      if (sMs >= eMs) {
        showError("La date de début doit être strictement antérieure à la date de fin.");
        return;
      }
      let apiBase; try { apiBase = await requireCameraBaseOrModal(); } catch { setStatus(""); return; }
      const start = fmtLocalToIsoZ(q('#start').value);
      const end = fmtLocalToIsoZ(q('#end').value);

      const res = await fetch(`${apiBase}/list?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`, { method: 'GET', headers: { 'Accept': 'application/json' } });
      if (!res.ok) { setStatus(`Erreur list: HTTP ${res.status}`); return; }

      const data = await res.json();
      const raw = Array.isArray(data.files) ? data.files : [];
      const normalized = raw.map(normalizeEntry);
      lastListed = normalized;
      if (!normalized.length) { setStatus("Aucun fichier sur cette période."); return; }

      const box = q('#files');
      normalized.forEach(f => {
        const div = document.createElement('div'); div.className = 'file';
        const left = f.ts || (f.tsDate ? f.tsDate.toISOString().replace(/[-:]/g, '').slice(0, 13) + 'Z_' : '');
        div.textContent = `${left}  |  ${f.path}  |  ${f.size} bytes`;
        box.appendChild(div);
      });

      renderSummary(normalized);
      setStatus(`${normalized.length} fichier(s) trouvés.`);
    }

    async function sendFiles() {
      if (!lastListed.length) { setStatus("Rien à envoyer. Cliquez d’abord sur Lister."); return; }
      let apiBase; try { apiBase = await requireCameraBaseOrModal(); } catch { return; }

      setStatus("Envoi en cours…");
      const body = JSON.stringify({ files: lastListed.map(f => f.path) });
      const res = await fetch(`${apiBase}/send`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body });
      if (!res.ok) { setStatus(`Erreur send: HTTP ${res.status}`); return; }

      const data = await res.json();
      setStatus("Terminé.", data.sent ?? 0, data.failed ?? 0);
    }

    q('#btnList').addEventListener('click', listFiles);
    q('#btnSend').addEventListener('click', sendFiles);

    // Custom Date Picker Implementation
    function createCalendar(container, input) {
      const now = new Date();
      let selectedDate = null;
      let currentYear = now.getFullYear();
      let currentMonth = now.getMonth();

      function renderCalendar() {
        container.innerHTML = '';

        // Header with month and year and navigation
        const header = document.createElement('div');
        header.className = 'calendar-header';

        const prevBtn = document.createElement('button');
        prevBtn.textContent = '<';
        prevBtn.type = 'button';
        prevBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          currentMonth--;
          if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
          }
          renderCalendar();
        });

        const nextBtn = document.createElement('button');
        nextBtn.textContent = '>';
        nextBtn.type = 'button';
        nextBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          currentMonth++;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
          }
          renderCalendar();
        });

        const monthYear = document.createElement('div');
        monthYear.textContent = new Date(currentYear, currentMonth).toLocaleString('fr-FR', { month: 'long', year: 'numeric' });

        header.appendChild(prevBtn);
        header.appendChild(monthYear);
        header.appendChild(nextBtn);
        container.appendChild(header);

        // Days of week
        const daysOfWeek = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
        const daysRow = document.createElement('div');
        daysRow.className = 'calendar-grid';
        daysOfWeek.forEach(d => {
          const day = document.createElement('div');
          day.className = 'calendar-day';
          day.textContent = d;
          daysRow.appendChild(day);
        });
        container.appendChild(daysRow);

        // Dates grid
        const datesGrid = document.createElement('div');
        datesGrid.className = 'calendar-grid';

        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const startDay = (firstDay.getDay() + 6) % 7; // Adjust for Monday start
        const totalDays = lastDay.getDate();

        // Empty slots before first day
        for (let i = 0; i < startDay; i++) {
          const empty = document.createElement('div');
          datesGrid.appendChild(empty);
        }

        // Dates
        for (let d = 1; d <= totalDays; d++) {
          const dateBtn = document.createElement('button');
          dateBtn.type = 'button';
          dateBtn.className = 'calendar-date';
          dateBtn.textContent = d;

          if (selectedDate &&
            selectedDate.getFullYear() === currentYear &&
            selectedDate.getMonth() === currentMonth &&
            selectedDate.getDate() === d) {
            dateBtn.classList.add('selected');
          }

          dateBtn.addEventListener('click', () => {
            selectedDate = new Date(currentYear, currentMonth, d, selectedDate ? selectedDate.getHours() : 0, selectedDate ? selectedDate.getMinutes() : 0);
            updateInput();
            renderCalendar();
          });

          datesGrid.appendChild(dateBtn);
        }

        container.appendChild(datesGrid);

        // Time inputs
        const timeDiv = document.createElement('div');
        timeDiv.className = 'time-inputs';

        const hourInput = document.createElement('input');
        hourInput.type = 'number';
        hourInput.min = 0;
        hourInput.max = 23;
        hourInput.value = selectedDate ? selectedDate.getHours() : 0;
        hourInput.addEventListener('input', () => {
          if (!selectedDate) selectedDate = new Date(currentYear, currentMonth, 1);
          selectedDate.setHours(Math.min(Math.max(0, parseInt(hourInput.value) || 0), 23));
          updateInput();
        });

        const minuteInput = document.createElement('input');
        minuteInput.type = 'number';
        minuteInput.min = 0;
        minuteInput.max = 59;
        minuteInput.value = selectedDate ? selectedDate.getMinutes() : 0;
        minuteInput.addEventListener('input', () => {
          if (!selectedDate) selectedDate = new Date(currentYear, currentMonth, 1);
          selectedDate.setMinutes(Math.min(Math.max(0, parseInt(minuteInput.value) || 0), 59));
          updateInput();
        });

        timeDiv.appendChild(hourInput);
        timeDiv.appendChild(document.createTextNode(':'));
        timeDiv.appendChild(minuteInput);
        container.appendChild(timeDiv);
      }

      function updateInput() {
        if (!selectedDate) return;
        const pad = (n) => String(n).padStart(2, '0');
        const isoStr = selectedDate.getUTCFullYear() + '-' +
          pad(selectedDate.getUTCMonth() + 1) + '-' +
          pad(selectedDate.getUTCDate()) + ' ' +
          pad(selectedDate.getUTCHours()) + ':' +
          pad(selectedDate.getUTCMinutes());
        input.value = isoStr;
        input.dispatchEvent(new Event('change'));
      }

      return {
        setDate(date) {
          selectedDate = date ? new Date(date) : null;
          if (selectedDate) {
            currentYear = selectedDate.getFullYear();
            currentMonth = selectedDate.getMonth();
          }
          renderCalendar();
        },
        toggle() {
          const isHidden = container.getAttribute('aria-hidden') === 'true';
          container.setAttribute('aria-hidden', isHidden ? 'false' : 'true');
          if (!isHidden) {
            container.blur();
          } else {
            renderCalendar();
            container.focus();
          }
        },
        hide() {
          container.setAttribute('aria-hidden', 'true');
        }
      };
    }

    function setupCustomDatePicker(pickerId, inputId, calendarId) {
      const picker = document.getElementById(pickerId);
      const input = document.getElementById(inputId);
      const calendar = document.getElementById(calendarId);

      const calendarObj = createCalendar(calendar, input);

      // Initialize with current input value or default
      if (input.value) {
        calendarObj.setDate(new Date(input.value));
      } else {
        calendarObj.setDate(new Date());
      }

      // Toggle calendar popup on button click
      picker.querySelector('.calendar-btn').addEventListener('click', () => {
        calendarObj.toggle();
      });

      // Hide calendar when clicking outside
      document.addEventListener('click', (e) => {
        if (!picker.contains(e.target)) {
          calendarObj.hide();
        }
      });

      // Update calendar if input value changes externally
      input.addEventListener('change', () => {
        if (input.value) {
          calendarObj.setDate(new Date(input.value));
        }
      });
    }

    // Setup custom date pickers for start and end
    setupCustomDatePicker('start-picker', 'start', 'start-calendar');
    setupCustomDatePicker('end-picker', 'end', 'end-calendar');
  </script>
</body>

</html>